pipeline {
  agent any
  environment {
    AWS_REGION = 'ap-south-1'             // change to your region
    ECR_REPO = '849652093376.dkr.ecr.ap-south-1.amazonaws.com/my-java-app' // change
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }
 
    stage('Build (Maven)') {
      steps {
        sh 'mvn clean package -DskipTests'
      }
      post {
        success {
          archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
        }
      }
    }
 
    stage('Docker Build & Push to ECR') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'aws-access-id', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
          sh '''
            # configure aws cli env for this shell
            export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            export AWS_DEFAULT_REGION=${AWS_REGION}
 
            # login to ECR, build, tag & push
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin ${ECR_REPO%/*}
            IMAGE_TAG=${GIT_COMMIT:0:7}
            docker build -t myapp:$IMAGE_TAG .
            docker tag myapp:$IMAGE_TAG $ECR_REPO:$IMAGE_TAG
            docker push $ECR_REPO:$IMAGE_TAG
            docker tag myapp:$IMAGE_TAG $ECR_REPO:latest
            docker push $ECR_REPO:latest
          '''
        }
      }
    }
 
    stage('Deploy') {
      steps {
        // simple: call an Ansible playbook or kubectl apply - replace with your method
        sh 'ansible-playbook ansible/deploy_k8s.yml -e image_tag=${GIT_COMMIT:0:7}'
      }
    }
  }
}
